<!DOCTYPE html>
<html>
<head>
    <title>ID Origin Patterns</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-is@18/umd/react-is.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@3.1.0/umd/Recharts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.6/babel.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
            background: #111;
            color: #fff;
            font-size: 16px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .dashboard {
            max-width: 95vw;
            margin: 0 auto;
            padding: 12px;
            height: 50vh;
            display: flex;
            flex-direction: column;
        }
        .card {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 0;
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }
        .city-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 0;
        }
        .city-button {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .city-button:hover {
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }
        .city-name {
            font-size: 42px;
            min-width: 200px;
            padding-top: 10px;
            text-align: center;
            font-weight: 500;
            background: #fafbfc;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .charts {
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            padding: 0 20px;
        }
        .chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: 20px 10px;
            min-width: 0;
            max-width: 48%;
            position: relative;
        }
        .chart-title {
            margin: 0;
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: #60A5FA;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        .stats-summary {
            text-align: center;
            padding: 16px;
        }
        .total-trips {
            font-size: 36px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 20px;
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        .trips-label {
            font-size: 24px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        /* Simple CSS hover effects - no JS needed */
        .recharts-pie-sector:hover {
            opacity: 1 !important;
            filter: brightness(1.1) !important;
        }
        .recharts-pie:hover .recharts-pie-sector:not(:hover) {
            opacity: 0.6 !important;
        }
        
        /* Ensure labels are always visible and unaffected by hover */
        .recharts-pie-label-text,
        .recharts-pie-label-line {
            opacity: 1 !important;
            pointer-events: none;
        }
        
        @media (max-width: 1200px) {
            .charts {
                flex-direction: column;
                gap: 20px;
                padding: 0 10px;
            }
            .chart {
                padding: 15px 5px;
                max-width: 100%;
            }
            .chart-title {
                top: 120px;
                font-size: 22px;
            }
            .trips-label {
                bottom: 80px;
                font-size: 15px;
            }
            .total-trips {
                bottom: 100px;
                font-size: 28px;
            }
            .dashboard {
                height: auto;
                min-height: 50vh;
            }
            .card {
                flex: none;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                padding: 8px;
            }
            .card {
                padding: 12px;
            }
            .dashboard-header {
                flex-direction: column;
                gap: 12px;
                top: 10px;
            }
            .city-selector {
                margin-left: 0;
            }
            .city-name {
                font-size: 1.6em;
            }
            .chart-title {
                font-size: 20px;
            }
            .total-trips {
                font-size: 24px;
            }
            .trips-label {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        function initializeApp() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Recharts === 'undefined') {
                console.log('Dependencies not ready, retrying...');
                setTimeout(initializeApp, 100);
                return;
            }

            const cityData = {"BE'ER SHEVA": {"BGU_trips": 19509.3, "Soroka_trips": 14043.8, "GavYam_trips": 3125.5, "mode_shares": {"bus": 11.138941660013378, "car": 66.99561549762483, "train": 0.0, "ped": 19.25103324485569, "bike": 0.9150100132811742, "multimodal": 1.6993995842249379}}, "RAHAT": {"BGU_trips": 691.1, "Soroka_trips": 1898.7, "GavYam_trips": 2.4, "mode_shares": {"bus": 11.433464812123727, "car": 87.50778492837865, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 1.0587502594976126}}, "OMER": {"BGU_trips": 474.6, "Soroka_trips": 274.29999999999995, "GavYam_trips": 157.0, "mode_shares": {"bus": 23.004842180774748, "car": 62.07182568149211, "train": 0.0, "ped": 9.392934002869442, "bike": 1.5266319942611193, "multimodal": 4.003766140602583}}, "OFAQIM": {"BGU_trips": 38.6, "Soroka_trips": 696.9, "GavYam_trips": 15.8, "mode_shares": {"bus": 22.597013204174594, "car": 74.2230294643372, "train": 0.0893732341578735, "ped": 0.0, "bike": 0.0, "multimodal": 3.090584097330335}}, "DIMONA": {"BGU_trips": 131.0, "Soroka_trips": 557.3, "GavYam_trips": 20.3, "mode_shares": {"bus": 34.08334360744668, "car": 59.57033657995315, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 6.346319812600172}}, "LAQYE": {"BGU_trips": 1831.8, "Soroka_trips": 399.9, "GavYam_trips": 0.0, "mode_shares": {"bus": 13.491028307540448, "car": 83.68526809320687, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 2.823703599252652}}, "ARAD": {"BGU_trips": 217.8, "Soroka_trips": 287.8, "GavYam_trips": 95.2, "mode_shares": {"bus": 31.030176899063477, "car": 62.278876170655565, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 6.690946930280957}}, "QIRYAT GAT": {"BGU_trips": 376.7999999999999, "Soroka_trips": 507.4, "GavYam_trips": 6.6, "mode_shares": {"bus": 21.94081135003325, "car": 70.82686765683883, "train": 5.220571935269342, "ped": 0.0, "bike": 0.0, "multimodal": 2.0117490578585677}}, "METAR": {"BGU_trips": 203.7, "Soroka_trips": 257.4, "GavYam_trips": 220.2, "mode_shares": {"bus": 35.18149423204687, "car": 57.353385275110234, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 7.465120492842908}}, "TEL SHEVA": {"BGU_trips": 54.2, "Soroka_trips": 31.3, "GavYam_trips": 0.0, "mode_shares": {"bus": 15.593895155938952, "car": 82.38590282385903, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 2.0202020202020203}}, "NETIVOT": {"BGU_trips": 39.099999999999994, "Soroka_trips": 331.3, "GavYam_trips": 8.3, "mode_shares": {"bus": 18.375477681112283, "car": 75.89234897146109, "train": 2.227823400276445, "ped": 0.0, "bike": 0.0, "multimodal": 3.5043499471501747}}, "SEGEV-SHALOM": {"BGU_trips": 0.0, "Soroka_trips": 104.0, "GavYam_trips": 12.1, "mode_shares": {"bus": 38.78263761849327, "car": 50.92300016630634, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 10.2943622152004}}, "TEL AVIV - YAFO": {"BGU_trips": 384.7, "Soroka_trips": 161.1, "GavYam_trips": 123.8, "mode_shares": {"bus": 13.207225630538513, "car": 66.25766871165644, "train": 17.390933878663937, "ped": 0.0, "bike": 0.0, "multimodal": 3.144171779141104}}, "LEHAVIM": {"BGU_trips": 166.4, "Soroka_trips": 138.2, "GavYam_trips": 83.4, "mode_shares": {"bus": 42.04390199471718, "car": 49.867929683942066, "train": 1.8307678294926677, "ped": 0.0, "bike": 0.0, "multimodal": 6.257400491848073}}, "YEROHAM": {"BGU_trips": 22.4, "Soroka_trips": 166.7, "GavYam_trips": 7.6, "mode_shares": {"bus": 38.8354847569349, "car": 55.62574384326649, "train": 0.0, "ped": 0.0, "bike": 0.0, "multimodal": 5.5387713997985895}}};

            const destinationColors = {
                BGU: '#60a5fa',
                Soroka: '#f87171',
                'Gav Yam': '#4ade80'
            };

            const modeColors = {
                car: '#ef4444',
                bus: '#3b82f6',
                bike: '#a855f7',
                pedestrian: '#00a307',
                multimodal: '#f59e0b',
                train: '#6366f1'
            };

            const toProperCase = (str) => {
                if (str === 'ped') return 'Pedestrian';
                return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
            };

            const CustomTooltip = ({ active, payload, destData, totalTrips }) => {
                if (active && payload && payload.length) {
                    const data = payload[0].payload;
                    const isDestination = destData.some(d => d.name === data.name);
                    
                    return (
                        <div style={{
                            background: 'rgba(0, 0, 0, 0.9)',
                            padding: '16px 20px',
                            border: '1px solid #444',
                            borderRadius: '8px',
                            fontSize: '16px',
                            boxShadow: '0 4px 20px rgba(0,0,0,0.5)',
                            backdropFilter: 'blur(10px)'
                        }}>
                            <p style={{margin: '0', color: '#fff', fontWeight: 'bold', fontSize: '18px'}}>
                                {data.name}
                            </p>
                            <p style={{margin: '6px 0 0 0', color: '#ccc', fontSize: '16px'}}>
                                {isDestination 
                                    ? `${data.value.toLocaleString()} trips (${((data.value/totalTrips)*100).toFixed(1)}%)`
                                    : `${data.value.toFixed(1)}%`
                                }
                            </p>
                        </div>
                    );
                }
                return null;
            };

            const renderCustomLabel = (chartSize, isDestinationChart) => ({ cx, cy, midAngle, innerRadius, outerRadius, percent, name, value }) => {
                if (percent < 0.03) return null;
                
                const RADIAN = Math.PI / 180;
                const radius = outerRadius + (chartSize * 0.08);
                const x = cx + radius * Math.cos(-midAngle * RADIAN);
                const y = cy + radius * Math.sin(-midAngle * RADIAN);
                
                const lineStartRadius = outerRadius + (chartSize * 0.015);
                const lineEndRadius = outerRadius + (chartSize * 0.065);
                const lineStartX = cx + lineStartRadius * Math.cos(-midAngle * RADIAN);
                const lineStartY = cy + lineStartRadius * Math.sin(-midAngle * RADIAN);
                const lineEndX = cx + lineEndRadius * Math.cos(-midAngle * RADIAN);
                const lineEndY = cy + lineEndRadius * Math.sin(-midAngle * RADIAN);

                const displayValue = isDestinationChart 
                    ? `${value.toLocaleString()}`
                    : `${value.toFixed(1)}%`;

                return (
                    <g>
                        <line
                            x1={lineStartX}
                            y1={lineStartY}
                            x2={lineEndX}
                            y2={lineEndY}
                            stroke="#666"
                            strokeWidth="1.5"
                        />
                        <line
                            x1={lineEndX}
                            y1={lineEndY}
                            x2={x > cx ? lineEndX + (chartSize * 0.04) : lineEndX - (chartSize * 0.04)}
                            y2={lineEndY}
                            stroke="#666"
                            strokeWidth="1.5"
                        />
                        <text 
                            x={x > cx ? lineEndX + (chartSize * 0.05) : lineEndX - (chartSize * 0.05)} 
                            y={lineEndY - 10} 
                            fill="#fff" 
                            textAnchor={x > cx ? 'start' : 'end'} 
                            dominantBaseline="central"
                            fontSize={Math.max(16, chartSize * 0.035)}
                            fontWeight="700"
                        >
                            {name}
                        </text>
                        <text 
                            x={x > cx ? lineEndX + (chartSize * 0.05) : lineEndX - (chartSize * 0.05)} 
                            y={lineEndY + 10} 
                            fill="#ccc" 
                            textAnchor={x > cx ? 'start' : 'end'} 
                            dominantBaseline="central"
                            fontSize={Math.max(14, chartSize * 0.028)}
                            fontWeight="600"
                        >
                            {displayValue}
                        </text>
                    </g>
                );
            };

            const App = () => {
                const [selectedCity, setSelectedCity] = React.useState(Object.keys(cityData)[0]);
                const [windowSize, setWindowSize] = React.useState({ width: window.innerWidth, height: window.innerHeight });
                
                React.useEffect(() => {
                    const handleResize = () => {
                        setWindowSize({ width: window.innerWidth, height: window.innerHeight });
                    };
                    
                    window.addEventListener('resize', handleResize);
                    return () => window.removeEventListener('resize', handleResize);
                }, []);
                
                const { PieChart, Pie, Cell, Tooltip } = Recharts;

                const currentCity = cityData[selectedCity];
                
                const destData = [
                    { name: 'BGU', value: currentCity.BGU_trips },
                    { name: 'Soroka', value: currentCity.Soroka_trips },
                    { name: 'Gav Yam', value: currentCity.GavYam_trips }
                ].filter(item => item.value > 0);
                
                const modeData = Object.entries(currentCity.mode_shares)
                    .map(([mode, share]) => ({
                        name: toProperCase(mode),
                        value: share
                    }))
                    .filter(item => item.value > 0)
                    .sort((a, b) => b.value - a.value);

                const totalTrips = destData.reduce((sum, item) => sum + item.value, 0);

                const renderPieChart = (data, colors, isDestinationChart = false) => {
                    const isSingleColumn = windowSize.width <= 1200;
                    const maxChartWidth = isSingleColumn 
                        ? Math.min(windowSize.width * 1, 1200)  // Much bigger for single column
                        : Math.min(windowSize.width * 0.5, 600); // Bigger for two columns
                    const chartSize = Math.min(maxChartWidth, windowSize.height * 0.65);
                    
                    // SVG container needs to be larger to accommodate labels that extend beyond the pie
                    const svgSize = chartSize * 1.25; // 25% larger to fit labels
                    
                    return (
                        <PieChart width={svgSize} height={svgSize}>
                            <Pie
                                data={data}
                                dataKey="value"
                                nameKey="name"
                                cx="50%"
                                cy="60%"
                                innerRadius={chartSize * 0.18}
                                outerRadius={chartSize * 0.32}
                                paddingAngle={2}
                                label={renderCustomLabel(chartSize, isDestinationChart)}
                                labelLine={false}
                            >
                                {data.map((entry, index) => (
                                    <Cell 
                                        key={`cell-${index}`}
                                        fill={colors[entry.name] || colors[entry.name.toLowerCase()]}
                                        style={{ cursor: 'pointer' }}
                                    />
                                ))}
                            </Pie>
                            <Tooltip content={(props) => <CustomTooltip {...props} destData={destData} totalTrips={totalTrips} />} />
                        </PieChart>
                    );
                };

                return (
                    <div className="dashboard">
                        <div className="card">
                            <div className="dashboard-header">
                                <div className="city-selector">
                                    <button 
                                        className="city-button"
                                        onClick={() => {
                                            const cities = Object.keys(cityData);
                                            const currentIndex = cities.indexOf(selectedCity);
                                            const prevIndex = (currentIndex - 1 + cities.length) % cities.length;
                                            setSelectedCity(cities[prevIndex]);
                                        }}
                                    >
                                        ←
                                    </button>
                                    <span className="city-name">{selectedCity}</span>
                                    <button 
                                        className="city-button"
                                        onClick={() => {
                                            const cities = Object.keys(cityData);
                                            const currentIndex = cities.indexOf(selectedCity);
                                            const nextIndex = (currentIndex + 1) % cities.length;
                                            setSelectedCity(cities[nextIndex]);
                                        }}
                                    >
                                        →
                                    </button>
                                </div>
                            </div>

                            <div className="charts">
                                <div className="chart">
                                    <h3 className="chart-title">
                                        Destination
                                    </h3>
                                    {renderPieChart(destData, destinationColors, true)}
                                </div>
                                
                                <div className="chart">
                                    <h3 className="chart-title">
                                        Mode
                                    </h3>
                                    {renderPieChart(modeData, modeColors, false)}
                                </div>
                            </div>
                            
                            <div className="stats-summary">
                                <div className="total-trips">{totalTrips.toLocaleString()}</div>
                                <div className="trips-label">Average Daily Total Trips</div>
                            </div>
                        </div>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>